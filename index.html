<!DOCTYPE html>
<html lang="en">
	<head>
	<title>NYC</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Mapzen CSS API -->
	<link rel="stylesheet" href="https://mapzen.com/js/mapzen.css">

	<!-- Leaflet CSS API -->
	<!-- NECESSARY??????????? -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ==" crossorigin=""/>



	<!-- jQuery API CDN -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<!-- Mapzen/Leaflet JS API CDN -->
	<script src="https://mapzen.com/js/mapzen.min.js"></script>

	<!-- CARTO DB API -->
	<!-- <script src="http://libs.cartocdn.com/cartodb.js/v3/3.15/cartodb.js"></script> -->


	<!-- Link to config.js file storing API keys -->
	<script type="text/javascript" src="config.js"></script>


	<style type="text/css">
		#map {
			height: 100%;
			width: 100%;
			position: absolute;	
		}

		html,body{margin: 0; padding: 0;}

		.info {
		    padding: 6px 8px;
		    font: 14px/16px Arial, Helvetica, sans-serif;
		    background: white;
		    background: rgba(255,255,255,0.8);
		    box-shadow: 0 0 15px rgba(0,0,0,0.2);
		    border-radius: 5px;
		}

		.boro-tooltip {
			color: white;
			background: black;
			font-size: 3em;
			opacity: .5;
			border-radius: 10px;
		}

		.nbhd-tooltip {
			color: white;
			background: black;
			font-size: 1.5em;
			opacity: .5;
			border-radius: 5px;
		}

		.sign-tooltip {
			color: white;
			background: black;
			font-size: 1em;
			opacity: .5;
			border-radius: 5px;
		}
	</style>
	</head>
	<body>
		<div id="map"></div>
		<script>

			// Retrieve API key and username from config.js
			var cartoUser = config.CARTO_USER;
			var mapzenKey = config.MAPZEN_KEY;



			// ==================================== MAP VARIABLES ====================================

			// Declare Mapzen API key
			L.Mapzen.apiKey = mapzenKey;

			// Adds map to page with integrated Leaflet API using Mapzen API for base map data
			var map = L.Mapzen.map('map', {
				//scene: L.Mapzen.BasemapStyles.Refill,
				center: [40.741368, -73.989428],	// sets initial centerpoint of map
				zoom: 11.5						// sets initial zoom (zoom buttons also included by default)
			});


			var boroTooltip = L.tooltip( {
					direction: top,
					sticky: true,
					className: 'boro-tooltip'		// CSS styling class
			});

			var nbhdTooltip = L.tooltip( {
					direction: top,
					sticky: true,
					className: 'nbhd-tooltip'		// CSS styling class
			});

			var signTooltip = L.tooltip( {
				sticky: true,
				className: 'sign-tooltip'
			});


			// Calls zoomLayerChange whenever the zoom level changes on the map
			map.on('zoomend', function (e) {
				zoomLayerChange();
			});


			// Adds a scale to the map in the bottom left corner
			L.control.scale().addTo(map);

			// Adds search functionality from Mapzen with Leaflet in top left corner
			// var geocoder = L.Mapzen.geocoder('mapzen-6fZzCy1', {
			// 	params: {
			// 		sources: 'osm',				// restricts search options to OpenStreetMaps (OSM)
			// 		'boundary.country': 'USA'	// restricts search options to within USA
			// 	}
			// });
			// geocoder.addTo(map);

			// Add layer of map data to map
			//var manhattanLayer = L.geoJson(null).addTo(map);




			// -------------------- GLOBAL VARIABLES ----------------------
			
			// Map layers
			var boroughLayer;
			var mSignLayer;
			var neighborhoodLayer;
			var boroNbhdsLayer;

			// Options for Leaflet circleMarker
			var signMarkerOptions = {
				radius: 7,
				fillColor: "#36a03d",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.8
			};



			// SQL queries for tests
			var sqlAllMSigns = "SELECT * FROM manhattan_signs";
			var sqlMNoParkingTaxiStand = "SELECT * FROM manhattan_signs WHERE sign_desc='NO PARKING TAXI STAND'";	// 3 results
			var sqlMNoParkingAnytime = "SELECT * FROM manhattan_signs WHERE sign_desc='NO PARKING ANYTIME'";		// 1885 results

			var sqlProxFlatiron = "SELECT * FROM manhattan_signs WHERE ST_DWithin(manhattan_signs.the_geom::geography,(select the_geom from flatiron where cartodb_id=1)::geography,1000)"

			var sqlBorough = "SELECT * FROM borough_boundaries";

			var sqlNeighborhoods = "SELECT * FROM neighborhood_tabulation_areas"

			// Endpoint for CARTO SQL API
			var endpoint = "https://" + cartoUser + ".carto.com/api/v2/sql?format=GeoJSON&q=";

			// Full urls to use in $.getJSON calls
			var boroughURL = endpoint + sqlBorough;
			var nbhdURL = endpoint + sqlNeighborhoods;
			var mSignsURL = endpoint + sqlProxFlatiron;
			//var boroNbhdsURL = endpoint





			// -------------------- CONTROL SETUP -----------------------

			// control to show sign description in top right of screen on hover
			var info = L.control();

			info.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'info');	// create a div with class "info"
				this.update();
				return this._div;
			};

			// Method used to update control based on feature properties passed
			info.update = function (props) {
				this._div.innerHTML = '<h4>Sign Description</h4>' + (props ? '<b>' +props.sign_desc + '</b><br />' + props.sign_id : 'Hover over a sign');
			};

			// add control to map
			info.addTo(map);




			// ----------------------------- STYLE FUNCTIONS ----------------------------

			// Functions to set default feature styles

			function boroStyle(feature) {
				return {
					color: '#21892f',
					fillColor: '#21892f',
					weight: 2,
					fillOpacity: 0.5,
					opacity: 1
				};
			}

			function nbhdStyle(feature) {
				return {
					color: '#232fdb',
					fillColor: '#232fdb',
					weight: 2,
					fillOpacity: 0.5,
					opacity: 1
				};
			}

			function signStyle(feature) {
				return {

				};
			}



			// -------------------- SIGN FUNCTIONS -----------------------

			// pointToLayer function for placing circle markers on map
			function plotMSigns(feature,latlng) {
				return L.circleMarker(latlng, signMarkerOptions);
			};


			// onEachFeature function for each sign
			function onEachMSign(feature,layer) {

				// add tooltip to each sign marker
				layer.bindTooltip(signTooltip);

				layer.on({
					mouseover: highlightSign,
					mouseout: resetSignHighlight,
				});

				//console.log("---> cartoID: " + layer.feature.properties.cartodb_id + " sign_id: " + layer.feature.properties.sign_id + " sign_desc: " + feature.properties.sign_desc);

			};


			// Determines events when feature is hovered over
			function highlightSign(e) {
				var layer = e.target;

				// set tooltip content to reflect sign description
				layer.setTooltipContent(layer.feature.properties.sign_desc);

				layer.setStyle({
					weight: 5,
					color: '#666',
					fillOpacity: 0.5
				});

				// handling for other browsers??? included in online example
				if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
					layer.bringToFront();
				};

				// call to control functions to show sign description in upper right corner
				info.update(layer.feature.properties);

				//console.log("sign_desc: " + layer.feature.properties.sign_desc);
			};

			// Removes styling/displays when feature is not hovered over
			function resetSignHighlight(e) {
				mSignLayer.resetStyle(e.target);

				// pass nothing to info method
				info.update();
			};



			// -------------------- BOROUGH FUNCTIONS -----------------------
			
			// onEachFeature function for each borough
			function onEachBoro(feature,layer) {

				// add tooltip to layer 		NOTE: this has to be here rather than in highlightBoro
				layer.bindTooltip(boroTooltip);

				// add event listeners to layer
				layer.on({
					mouseover: highlightBoro,
					mouseout: resetBoroHighlight,
					click: zoomToBoro
				});
			};

			// Determines events when feature is hovered over
			function highlightBoro(e) {
				
				var layer = e.target;

				// NOTE: this has to be here rather than in parent function onEachBoro
				layer.setTooltipContent(layer.feature.properties.boro_name);

				layer.setStyle({
					weight: 5,
					color: '#63497c',
					fillColor: '#63497c',
					fillOpacity: 0.7
				});

				// handling for other browsers??? included in online example
				if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
					layer.bringToFront();
				};

				console.log("borough: " + layer.feature.properties.boro_name);
			};

			// Removes styling/displays when feature is not hovered over
			function resetBoroHighlight(e) {
				boroughLayer.resetStyle(e.target);
			};

			function zoomToBoro(e) {

				var boroName = e.target.feature.properties.boro_name;
				var centerpoint;

				// CHECK TO SEE IF THIS IS NECESSARY
				// remove borough-specific layers upon new borough selection
				if (map.hasLayer(boroNbhdsLayer)) {
					map.removeLayer(boroNbhdsLayer);
				}

				// manual override for Queens centerpoint, otherwise use centerpoint of borough bounds
				if (boroName == "Queens") {
					centerpoint = L.latLng(40.719805, -73.823359);
				} else {
					centerpoint = e.target.getBounds().getCenter();
				}

				// Set map focused on borough with constant zoom level
				map.setView(centerpoint, 12.2);

				// Show neighborhood information specific to borough selected
				showBoroNbhds(boroName);
			};


			// -------------------- NEIGHBORHOOD FUNCTIONS -----------------------
			
			// onEachFeature function for each neighborhood
			function onEachNbhd(feature,layer) {

				// add tooltip to layer 		NOTE: this has to be here rather than in highlightBoro
				layer.bindTooltip(nbhdTooltip);

				// add event listeners to layer
				layer.on({
					mouseover: highlightNbhd,
					mouseout: resetNbhdHighlight,
					click: zoomToNbhd
				});
			};

			// Determines events when feature is hovered over
			function highlightNbhd(e) {
				var layer = e.target;

				// NOTE: this has to be here rather than in parent function onEachBoro
				layer.setTooltipContent(layer.feature.properties.ntaname);

				layer.setStyle({
					weight: 5,
					color: '#e6f939',
					fillColor: '#e6f939',
					opacity: 0.5,
					fillOpacity: 0.5
				});

				// handling for other browsers??? included in online example
				if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
					layer.bringToFront();
				};

				console.log("neighborhood: " + layer.feature.properties.ntaname);
			};

			// Removes styling/displays when feature is not hovered over
			function resetNbhdHighlight(e) {
				neighborhoodLayer.resetStyle(e.target);
			};

			// focus on neighborhood when clicked
			function zoomToNbhd(e) {
				map.fitBounds(e.target.getBounds());
			};



			// -------------------- MAIN FUNCTIONS -----------------------

			// Displays different layers based on zoom level
			function zoomLayerChange() {

				var currentZoom = map.getZoom();

				console.log("zoom = " + currentZoom);
				//console.log("center = " + map.getCenter());

				//alert("zoom = " + currentZoom);

				if (currentZoom > 16) {
					//console.log("true1");
					map.removeLayer(boroughLayer);
					map.removeLayer(neighborhoodLayer);
					map.removeLayer(boroNbhdsLayer);
					mSignLayer.addTo(map);
				}
				else if (currentZoom < 16 && currentZoom > 13) {
					map.removeLayer(mSignLayer);
					map.removeLayer(boroNbhdsLayer);
					neighborhoodLayer.addTo(map);
				}
				else if (currentZoom < 16 && currentZoom > 12.2) {
					//console.log("true2");
					map.removeLayer(mSignLayer);
					//neighborhoodLayer.addTo(map);
				}
				else if (currentZoom < 12.2) {
					//console.log("true3");
					//console.log("hello");
					//map.removeLayer(mSignLayer);
					map.removeLayer(neighborhoodLayer);
					map.removeLayer(boroNbhdsLayer);
					boroughLayer.addTo(map);
				}
			};

			// Creates signs per SQL query to CARTO tables API
			function showSigns(){

				// Remove any pre-existing layer
				if(map.hasLayer(mSignLayer)){
					map.removeLayer(mSignLayer);
				};

				// jQuery function to retrieve data from CARTO DB
				$.getJSON(mSignsURL, function(data) {
					mSignLayer = L.geoJSON(data, {
						pointToLayer: plotMSigns,	// function to place circle markers for sign on map
						onEachFeature: onEachMSign	// function to show sign information/interactivity
					}); //.addTo(map);
				})
				// Alert when getJSON succeeds
				.done(function() {
					console.log("sign $geoJSON succeeded");
					// alert( "$.getJSON succeeded");
				})
				// Alert when getJSON fails
				.fail(function() {
					alert( "$.getJSON failed");
				});
			};

		

			// Creates neighborhood boundaries layer
			function showNeighborhoods(){

				if (map.hasLayer(neighborhoodLayer)) {
					map.removeLayer(neighborhoodLayer);
				};

				// jQuery function to retrieve data from CARTO DB
				$.getJSON(nbhdURL, function(data) {
					neighborhoodLayer = L.geoJSON(data, {
						style: nbhdStyle,
						onEachFeature: onEachNbhd	// function to add neighborhood interactivity
					}); //.addTo(map);
				})
				// Alert when getJSON succeeds
				.done(function() {
					console.log("neighborhood $geoJSON succeeded");
					// alert( "$.getJSON succeeded");
				})
				// Alert when getJSON fails
				.fail(function() {
					alert( "$.getJSON failed");
				});

			};

			// Creates borough boundaries layer
			function showBoroughs(){

				if (map.hasLayer(boroughLayer)) {
					map.removeLayer(boroughLayer);
				};

				// jQuery function to retrieve data from CARTO DB
				$.getJSON(boroughURL, function(data) {
					boroughLayer = L.geoJSON(data, {
						style: boroStyle,			// function to set default styling
						onEachFeature: onEachBoro	// function to show borough interactivity
					})
					.addTo(map);
				})
				// Alert when getJSON succeeds
				.done(function() {
					console.log("borough $geoJSON succeeded");
					// alert( "$.getJSON succeeded");
				})
				// Alert when getJSON fails
				.fail(function() {
					alert( "$.getJSON failed");
				});

			};

			// Displays neighborhoods depending on borough selected
			function showBoroNbhds(boro){

				var nbhdSQL;

				switch(boro) {
					case "Manhattan":
						nbhdSQL = "SELECT * FROM neighborhood_tabulation_areas WHERE boro_name='Manhattan'";
						break;
					case "Brooklyn":
						nbhdSQL = "SELECT * FROM neighborhood_tabulation_areas WHERE boro_name='Brooklyn'";
						break;
					case "Queens":
						nbhdSQL = "SELECT * FROM neighborhood_tabulation_areas WHERE boro_name='Queens'";
						break;
					case "Bronx":
						nbhdSQL = "SELECT * FROM neighborhood_tabulation_areas WHERE boro_name='Bronx'";
						break;
					case "Staten Island":
						nbhdSQL = "SELECT * FROM neighborhood_tabulation_areas WHERE boro_name='Staten Island'";
						break;
					default:
						nbhdSQL = "SELECT * FROM neighborhood_tabulation_areas";
						break;
				}

				if (map.hasLayer(boroNbhdsLayer)) {
					map.removeLayer(boroNbhdsLayer);
				}
				// else if (map.hasLayer(neighborhoodLayer)) {
				// 	map.removeLayer(neighborhoodLayer);
				// }

				// set URL call to CARTO DB based on borough selected
				boroNbhdsURL = endpoint + nbhdSQL;

				// jQuery function to retrieve data from CARTO DB
				$.getJSON(boroNbhdsURL, function(data) {
					boroNbhdsLayer = L.geoJSON(data, {
						style: nbhdStyle,
						onEachFeature: onEachNbhd	// function to show borough interactivity
					})
					.addTo(map);
				})
				// Alert when getJSON succeeds
				.done(function() {
					console.log("boroNbhds $geoJSON succeeded");
					// alert( "$.getJSON succeeded");
				})
				// Alert when getJSON fails
				.fail(function() {
					alert( "$.getJSON failed");
				});

			}

			// Creates each layer
			function drawMap(){
				console.log("initial zoom = " + map.getZoom());
				
				showBoroughs();
				showNeighborhoods();
				showSigns();
				
			}


			// jQuery function that checks if entire DOM has loaded before proceding
			$( document ).ready(function() {
				console.log("document ready!");
				
				drawMap();
				
			});


		</script>
	</body>
</html>