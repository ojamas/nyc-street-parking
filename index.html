<!DOCTYPE html>
<html lang="en">
	<head>
	<title>NYC</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<!-- Mapzen CSS API -->
	<link rel="stylesheet" href="https://mapzen.com/js/mapzen.css">

	<!-- Leaflet CSS API -->
	<!-- NECESSARY??????????? -->
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" integrity="sha512-07I2e+7D8p6he1SIM+1twR5TIrhUQn9+I6yjqD53JQjFiMf8EtC93ty0/5vJTZGF8aAocvHYNEDJajGdNx1IsQ==" crossorigin=""/>

	<!-- jQuery API CDN -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

	<!-- Mapzen/Leaflet JS API CDN -->
	<script src="https://mapzen.com/js/mapzen.min.js"></script>


	<!-- Link to config.s file storing API keys -->
	<script type="text/javascript" src="config.js"></script>


	<style type="text/css">
		#map {
			height: 100%;
			width: 100%;
			position: absolute;	
		}

		html,body{margin: 0; padding: 0;}

		.info {
		    padding: 6px 8px;
		    font: 14px/16px Arial, Helvetica, sans-serif;
		    background: white;
		    background: rgba(255,255,255,0.8);
		    box-shadow: 0 0 15px rgba(0,0,0,0.2);
		    border-radius: 5px;
		}
	</style>
	</head>
	<body>
		<div id="map"></div>
		<script>

			// Retrieve API key and username from config.js
			var cartoUser = config.CARTO_USER;
			var mapzenKey = config.MAPZEN_KEY;


			// Declare Mapzen API key
			L.Mapzen.apiKey = mapzenKey;

			// Adds map to page with integrated Leaflet API using Mapzen API for base map data
			var map = L.Mapzen.map('map', {
				center: [40.741368, -73.989428],	// sets initial centerpoint of map
				zoom: 18						// sets initial zoom (zoom buttons also included by default)
			});

			// Adds a scale to the map in the bottom left corner
			L.control.scale().addTo(map);

			// Adds search functionality from Mapzen with Leaflet in top left corner
			// var geocoder = L.Mapzen.geocoder('mapzen-6fZzCy1', {
			// 	params: {
			// 		sources: 'osm',				// restricts search options to OpenStreetMaps (OSM)
			// 		'boundary.country': 'USA'	// restricts search options to within USA
			// 	}
			// });
			// geocoder.addTo(map);

			// Add layer of map data to map
			//var manhattanLayer = L.geoJson(null).addTo(map);




			// -------------------- GLOBAL VARIABLES ----------------------
			
			// Manhattan sign layer
			var mSignLayer;

			// Options for Leaflet circleMarker
			var signMarkerOptions = {
				radius: 8,
				fillColor: "#36a03d",
				color: "#000",
				weight: 1,
				opacity: 1,
				fillOpacity: 0.8
			};



			// SQL queries for tests
			var sqlAllMSigns = "SELECT * FROM manhattan_signs";
			var sqlMNoParkingTaxiStand = "SELECT * FROM manhattan_signs WHERE sign_desc='NO PARKING TAXI STAND'";	// 3 results
			var sqlMNoParkingAnytime = "SELECT * FROM manhattan_signs WHERE sign_desc='NO PARKING ANYTIME'";		// 1885 results

			var sqlProxFlatiron = "SELECT * FROM manhattan_signs WHERE ST_DWithin(manhattan_signs.the_geom::geography,(select the_geom from flatiron where cartodb_id=1)::geography,100)"

			// Endpoint for CARTO SQL API
			var endpoint = "https://" + cartoUser + ".carto.com/api/v2/sql?format=GeoJSON&q=";

			// Full url to use in $.getJSON call
			var url = endpoint + sqlProxFlatiron;





			// -------------------- CONTROL SETUP -----------------------

			// control to show sign description in top right of screen on hover
			var info = L.control();

			info.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'info');	// create a div with class "info"
				this.update();
				return this._div;
			};

			// Method used to update control based on feature properties passed
			info.update = function (props) {
				this._div.innerHTML = '<h4>Sign Description</h4>' + (props ? '<b>' +props.sign_desc + '</b><br />' + props.sign_id : 'Hover over a sign');
			};

			// add control to map
			info.addTo(map);



			// -------------------- SIGN FUNCTIONS -----------------------

			// Determines events when feature is hovered over
			function highlightFeature(e) {
				var layer = e.target;

				layer.setStyle({
					weight: 5,
					color: '#666',
					fillOpacity: 0.5
				});

				// handling for other browsers??? included in online example
				if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
					layer.bringToFront();
				};

				// call to control functions to show sign description in upper right corner
				info.update(layer.feature.properties);

				console.log("sign_desc: " + layer.feature.properties.sign_desc);
			};

			// Removes styling/displays when feature is not hovered over
			function resetHighlight(e) {
				mSignLayer.resetStyle(e.target);

				// pass nothing to info method
				info.update();
			};

			// pointToLayer function for placing circle markers on map
			function plotMSigns(feature,latlng) {
				return L.circleMarker(latlng, signMarkerOptions)
					.bindTooltip(feature.properties.sign_desc).openTooltip();	// adds a tooltip to each marker
			};

			// onEachFeature function for each sign
			function onEachMSign(feature,layer) {
				layer.on({
					mouseover: highlightFeature,
					mouseout: resetHighlight,
				});

				console.log("---> cartoID: " + layer.feature.properties.cartodb_id + " sign_id: " + layer.feature.properties.sign_id + " sign_desc: " + feature.properties.sign_desc);

			};



			// -------------------- MAIN FUNCTION -----------------------

			// Displays signs per SQL query to CARTO tables API
			function showSigns(){

				console.log("showSigns() started");

				// Remove any pre-existing layer
				if(map.hasLayer(mSignLayer)){
					map.removeLayer(mSignLayer);
				};

				// jQuery function to retrieve data from CARTO DB
				$.getJSON(url, function(data) {
					mSignLayer = L.geoJSON(data, {
						pointToLayer: plotMSigns,	// function to place circle markers for sign on map
						onEachFeature: onEachMSign	// function to 
					}).addTo(map);
				})
				// Alert when getJSON succeeds
				.done(function() {
					console.log("$geoJSON succeeded");
					// alert( "$.getJSON succeeded");
				})
				// Alert when getJSON fails
				.fail(function() {
					alert( "$.getJSON failed");
				});

				console.log("showSigns() ended");
			};

			// jQuery function that checks if entire DOM has loaded before proceding
			$( document ).ready(function() {
				console.log("document ready!");
				// Run showSigns function automatically when document is fully loaded
				showSigns();
				//console.log("document script finished");
			});


		</script>
	</body>
</html>